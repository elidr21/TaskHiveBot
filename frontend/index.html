<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Task Hive Chat</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
    rel="stylesheet"
  />

  <!-- FontAwesome for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />

  <!-- Main stylesheet -->
  <link rel="stylesheet" href="../static/style.css" />
</head>
<body>
  <nav class="top-nav">
    <a href="/" class="home-link">
      <i class="fas fa-home"></i>
      Back to Home
    </a>
  </nav>

  <div class="app-container">
    <!-- SIDE PANEL -->
    <div class="side-panel" id="side-panel">
      <div class="panel-header">
        <h2><i class="fas fa-tasks"></i> Task Tracker</h2>
        <button id="toggle-panel" class="panel-toggle">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      
      <div class="task-filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="active">Active</button>
        <button class="filter-btn" data-filter="completed">Completed</button>
      </div>

      <div class="task-stats">
        <div class="stat-item">
          <span class="stat-value" id="total-tasks">0</span>
          <span class="stat-label">Total</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="active-tasks">0</span>
          <span class="stat-label">Active</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="completed-tasks">0</span>
          <span class="stat-label">Completed</span>
        </div>
      </div>

      <div class="tasks-container">
        <div class="tasks-list" id="tasks-list">
          <!-- Tasks will be added here dynamically -->
        </div>
      </div>
    </div>

    <!-- Move the reopen button here, outside the side panel -->
    <button class="panel-reopen-btn" id="reopen-panel">
      <i class="fas fa-chevron-right"></i>
    </button>

    <!-- CHAT CONTAINER -->
    <div class="chat-container">
      <!-- CHAT HEADER -->
      <div class="chat-header">
        <div class="chat-title">
          <i class="fas fa-robot"></i>
          <h2>Beatrix the Bee</h2>
        </div>
        <button id="minimize-chat">
          <i class="fas fa-minus"></i>
        </button>
      </div>

      <!-- CHAT MESSAGES -->
      <div class="chat-messages" id="chat-messages">
        <!-- Initial Bot Message -->
        <div class="message bot-message">
          <div class="avatar">
            <i class="fas fa-robot"></i>
          </div>
          <div class="message-content">
            <p>Bzz! üêù Hello! I'm Beatrix, your AI assistant. How can I help you today?</p>
            <p>You can ask me to:</p>
            <ul>
              <li>Add tasks with "add task: [description]"</li>
              <li>Complete tasks with "complete task: [number]"</li>
              <li>Remove tasks with "remove task: [number]"</li>
            </ul>
            <span class="timestamp">Now</span>
          </div>
        </div>
      </div>

      <!-- CHAT INPUT -->
      <div class="chat-input-container">
        <input 
          type="text" 
          id="message-input" 
          placeholder="Type your message..."
          autocomplete="off"
        />
        <button id="send-button">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const chatMessages = document.getElementById('chat-messages');
      const messageInput = document.getElementById('message-input');
      const sendButton = document.getElementById('send-button');
      const minimizeButton = document.getElementById('minimize-chat');
      const chatContainer = document.querySelector('.chat-container');
      const tasksList = document.getElementById('tasks-list');
      const sidePanel = document.getElementById('side-panel');
      const togglePanel = document.getElementById('toggle-panel');
      const filterButtons = document.querySelectorAll('.filter-btn');
      let currentFilter = 'all';
      let tasks = [];

      // Update task statistics
      function updateStats() {
        const total = tasks.length;
        const completed = tasks.filter(t => t.completed).length;
        const active = total - completed;

        document.getElementById('total-tasks').textContent = total;
        document.getElementById('active-tasks').textContent = active;
        document.getElementById('completed-tasks').textContent = completed;
      }

      // Filter tasks based on current filter
      function filterTasks() {
        return tasks.filter(task => {
          if (currentFilter === 'all') return true;
          if (currentFilter === 'active') return !task.completed;
          if (currentFilter === 'completed') return task.completed;
          return true;
        });
      }

      // Update tasks display
      function updateTasks(updatedTasks) {
        tasks = updatedTasks || tasks;
        updateStats();
        
        const filteredTasks = filterTasks();
        tasksList.innerHTML = '';
        
        if (filteredTasks.length === 0) {
          tasksList.innerHTML = '<p class="no-tasks">No tasks yet!</p>';
          return;
        }
        
        filteredTasks.forEach(task => {
          const taskElement = document.createElement('div');
          taskElement.className = `task-item ${task.completed ? 'completed' : ''}`;
          taskElement.innerHTML = `
            <div class="task-content">
              <span class="task-id">${task.id}.</span>
              <span class="task-text">${task.text}</span>
            </div>
            <div class="task-actions">
              <button class="task-action complete" onclick="completeTask(${task.id})">
                <i class="fas fa-check"></i>
              </button>
              <button class="task-action remove" onclick="removeTask(${task.id})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          tasksList.appendChild(taskElement);
        });
      }

      // Add message to chat
      function addMessage(message, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        
        messageDiv.innerHTML = `
          <div class="avatar">
            <i class="fas ${sender === 'user' ? 'fa-user' : 'fa-robot'}"></i>
          </div>
          <div class="message-content">
            <div class="message-text">
              <p>${message}</p>
            </div>
            <div class="message-footer">
              <span class="timestamp">${new Date().toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
              })}</span>
              ${sender === 'bot' ? `
                <div class="message-actions">
                  <button class="action-btn copy-btn" aria-label="Copy message">
                    <i class="fas fa-copy"></i>
                  </button>
                  <button class="action-btn react-btn" aria-label="React to message">
                    <i class="fas fa-smile"></i>
                  </button>
                </div>
              ` : ''}
            </div>
          </div>
        `;

        // Add copy functionality
        const copyBtn = messageDiv.querySelector('.copy-btn');
        if (copyBtn) {
          copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(message);
            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
              copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            }, 2000);
          });
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Update typing indicator
      function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot-message typing';
        typingDiv.innerHTML = `
          <div class="avatar">
            <i class="fas fa-robot"></i>
          </div>
          <div class="message-content">
            <div class="typing-indicator">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        `;
        return typingDiv;
      }

      // Send message
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        // Add user message
        addMessage(message, 'user');
        messageInput.value = '';

        // Show typing indicator
        const typingDiv = showTypingIndicator();
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
          const response = await fetch('/api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
          });

          if (!response.ok) {
            throw new Error('Network response was not ok');
          }

          const data = await response.json();
          chatMessages.removeChild(typingDiv);
          addMessage(data.content, 'bot');
          
          // Update tasks if they were modified
          if (data.tasks) {
            updateTasks(data.tasks);
          }
        } catch (error) {
          chatMessages.removeChild(typingDiv);
          addMessage("I'm having trouble connecting. Please try again.", 'bot');
          console.error('Error:', error);
        }
      }

      // Task action functions
      window.completeTask = async function(taskId) {
        await sendMessage(`complete task: ${taskId}`);
      };

      window.removeTask = async function(taskId) {
        await sendMessage(`remove task: ${taskId}`);
      };

      // Event Listeners
      sendButton.addEventListener('click', sendMessage);
      
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      minimizeButton.addEventListener('click', () => {
        chatContainer.classList.toggle('minimized');
        minimizeButton.innerHTML = chatContainer.classList.contains('minimized') 
          ? '<i class="fas fa-plus"></i>' 
          : '<i class="fas fa-minus"></i>';
      });

      // Side panel toggle
      togglePanel.addEventListener('click', () => {
        sidePanel.classList.add('collapsed');
        togglePanel.innerHTML = '<i class="fas fa-chevron-right"></i>';
      });

      // Reopen panel
      const reopenButton = document.getElementById('reopen-panel');
      reopenButton.addEventListener('click', () => {
        sidePanel.classList.remove('collapsed');
        togglePanel.innerHTML = '<i class="fas fa-chevron-left"></i>';
      });

      // Filter buttons
      filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          filterButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          updateTasks();
        });
      });

      // Initialize tasks from localStorage if available
      const savedTasks = localStorage.getItem('tasks');
      if (savedTasks) {
        tasks = JSON.parse(savedTasks);
        updateTasks();
      }
    });
  </script>
</body>
</html>